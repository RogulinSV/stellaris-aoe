engage_intelligencer_espionage_purpose_steal_resources = {
    event_target:espionage_origin_spy = {
        set_pop_flag = "espionage_purpose_steal_resources"
        log = ">>> engage_intelligencer_espionage_purpose_steal_technologies effect: pop was engaged from stealing resources"
    }
}

engage_intelligencer_espionage_purpose_steal_technologies = {
    event_target:espionage_origin_spy = {
        set_pop_flag = "espionage_purpose_steal_technologies"
        log = ">>> engage_intelligencer_espionage_purpose_steal_technologies effect: pop was engaged from stealing technologies"
    }
}

disengage_intelligencer = {
    event_target:espionage_origin_spy = {
        if = {
            limit = {
                has_pop_flag = "espionage_purpose_steal_resources"
            }
            remove_pop_flag = "espionage_purpose_steal_resources"
            log = ">>> disengage_intelligencer effect: pop was disengaged from stealing resources"
        }
        if = {
            limit = {
                has_pop_flag = "espionage_purpose_steal_technologies"
            }
            remove_pop_flag = "espionage_purpose_steal_technologies"
            log = ">>> disengage_intelligencer effect: pop was disengaged from stealing technologies"
        }
    }
}

set_intelligencer_on_assignment = {
    event_target:espionage_origin_spy = {
        set_timed_pop_flag = {
            flag = "intelligencer_on_assignment"
            days = 10
        }
        log = ">>> set_intelligencer_on_assignment effect: pop was assigned for espionage action"
    }
}

count_espionage_subjects = {
    event_target:espionage_origin_country = {
        set_variable = {
            which = "possibly_affected_by_espionage_counter"
            value = 1
        }
    }
    every_country = {
        limit = {
            is_subject_of_espionage = yes
        }
        event_target:espionage_origin_country = {
            change_variable = {
                which = "possibly_affected_by_espionage_counter"
                value = 1
            }
        }
    }
    log = ">>> count_espionage_subjects effect: countries [event_target:espionage_origin_country.possibly_affected_by_espionage_counter] was counted as possible espionage subject for [event_target:espionage_origin_country.GetName]"
}

find_espionage_subject = {
    random_country = {
        limit = {
            is_subject_of_espionage = yes
        }
        set_timed_country_flag = {
            flag = espionage_target_country@event_target:espionage_origin_country
            days = 3
        }
        save_event_target_as = "espionage_target_country"
        log = ">>> find_espionage_subject effect: country [event_target:espionage_target_country.GetName] was selected as espionage subject for [event_target:espionage_origin_country.GetName]"
    }
}

# Scope: country
try_steal_resources = {
    event_target:espionage_origin_country = {
        set_variable = {
            which = "gained_by_espionage_value"
            value = 0
        }
    }
    event_target:espionage_target_country = {
        set_variable = {
            which = "stolen_by_espionage_value"
            value = 0
        }
    }
    random_list = {
        10 = {
            modifier = {
                factor = 100
                is_fallen_empire = yes
            }
            modifier = {
                factor = 2.5
                exists = event_target:espionage_target_planet
                event_target:espionage_target_planet = {
                    count_pops = {
                        limit = {
                            is_intelligencer_has_purpose_steal_resources = yes
                            is_unassignment_intelligencer = yes
                        }
                        count > 2
                    }
                }
            }
            modifier = {
                factor = 0.5
                exists = event_target:espionage_target_planet
                event_target:espionage_target_planet = {
                    count_pops = {
                        limit = {
                            is_intelligencer_has_purpose_steal_resources = yes
                            is_unassignment_intelligencer = yes
                        }
                        count < 2
                    }
                }
            }
            modifier = {
                factor = 0.1
                exists = event_target:espionage_target_planet
                event_target:espionage_target_planet = {
                    count_pops = {
                        limit = {
                            is_intelligencer_has_purpose_steal_resources = yes
                            is_unassignment_intelligencer = yes
                        }
                        count = 0
                    }
                    NOR = {
                        has_building = "building_intelligence_agency_1"
                        has_building = "building_intelligence_agency_2"
                        has_building = "building_intelligence_agency_3"
                    }
                }
            }
        }
        1 = {
            event_target:espionage_origin_country = {
                add_monthly_resource_mult = {
                    resource = minerals
                    value = @tier1materialreward
                    min = @tier1materialmin
                    max = @tier1materialmax
                }
                set_variable = {
                    which = "gained_by_espionage_value"
                    value = @tier1materialreward
                }
                create_message = {
                    type = MESSAGE_SPY_GAINED_MINERALS
                    localization = MESSAGE_SPY_GAINED_MINERALS_MULT_LOCALISATION
                    days = 30
                    target = this
                    variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                    variable = { type = name localization = TARGET_COUNTRY scope = event_target:espionage_target_country }
                    variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                }
            }
            log = ">>> try_steal_resources effect: monthly minerals mult was gained"
        }
        1 = {
            modifier = {
                factor = 10
                event_target:espionage_origin_country = {
                    resource_stockpile_compare = {
                        resource = minerals
                        value < 1000
                    }
                }
            }
            modifier = {
                factor = 0
                event_target:espionage_origin_country = {
                    resource_stockpile_compare = {
                        resource = minerals
                        value >= 25000
                    }
                }
            }
            if = {
                limit = {
                    event_target:espionage_target_country = {
                        has_country_resource = {
                            type = minerals
                            amount >= 200
                        }
                    }
                }
                event_target:espionage_target_country = {
                    add_resource = {
                        minerals = -200
                    }
                    set_variable = {
                        which = "stolen_by_espionage_value"
                        value = 200
                    }
                    create_message = {
                        type = MESSAGE_SPY_STOLE_MINERALS
                        localization = MESSAGE_SPY_STOLE_MINERALS_X200_LOCALISATION
                        days = 30
                        target = this
                        variable = { type = name localization = ORIGIN_COUNTRY scope = event_target:espionage_origin_country }
                        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                    }
                }
                event_target:espionage_origin_country = {
                    add_resource = {
                        minerals = 200
                    }
                    set_variable = {
                        which = "gained_by_espionage_value"
                        value = 200
                    }
                    create_message = {
                        type = MESSAGE_SPY_GAINED_MINERALS
                        localization = MESSAGE_SPY_GAINED_MINERALS_X200_LOCALISATION
                        days = 30
                        target = this
                        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                        variable = { type = name localization = TARGET_COUNTRY scope = event_target:espionage_target_country }
                        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                    }
                }
                log = ">>> try_steal_resources effect: 200 minerals was stolen"
            }
            else_if = {
                limit = {
                    event_target:espionage_target_country = {
                        has_country_resource = {
                            type = minerals
                            amount >= 100
                        }
                    }
                }
                event_target:espionage_target_country = {
                    add_resource = {
                        minerals = -100
                    }
                    set_variable = {
                        which = "stolen_by_espionage_value"
                        value = 100
                    }
                    create_message = {
                        type = MESSAGE_SPY_STOLE_MINERALS
                        localization = MESSAGE_SPY_STOLE_MINERALS_X100_LOCALISATION
                        days = 30
                        target = this
                        variable = { type = name localization = ORIGIN_COUNTRY scope = event_target:espionage_origin_country }
                        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                    }
                }
                event_target:espionage_origin_country = {
                    add_resource = {
                        minerals = 100
                    }
                    set_variable = {
                        which = "gained_by_espionage_value"
                        value = 100
                    }
                    create_message = {
                        type = MESSAGE_SPY_GAINED_MINERALS
                        localization = MESSAGE_SPY_GAINED_MINERALS_X100_LOCALISATION
                        days = 30
                        target = this
                        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                        variable = { type = name localization = TARGET_COUNTRY scope = event_target:espionage_target_country }
                        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                    }
                }
                log = ">>> try_steal_resources effect: 100 minerals was stolen"
            }
            else = {
                event_target:espionage_origin_country = {
                    add_resource = {
                        minerals = 50
                    }
                    set_variable = {
                        which = "gained_by_espionage_value"
                        value = 50
                    }
                    create_message = {
                        type = MESSAGE_SPY_GAINED_MINERALS
                        localization = MESSAGE_SPY_GAINED_MINERALS_X50_LOCALISATION
                        days = 30
                        target = this
                        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
                        variable = { type = name localization = TARGET_COUNTRY scope = event_target:espionage_target_country }
                        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
                    }
                    log = ">>> try_steal_resources effect: 50 minerals was stolen"
                }
            }
        }
    }
}

# Scope: origin country
try_steal_technologies = {
    event_target:espionage_origin_country = {
        set_variable = {
            which = "gained_by_espionage_value"
            value = 0
        }
    }
    event_target:espionage_target_country = {
        set_variable = {
            which = "stolen_by_espionage_value"
            value = 0
        }
    }
    create_message = {
        type = MESSAGE_SPY_GAINED_MINERALS
        localization = MESSAGE_SPY_GAINED_MINERALS_X50_LOCALISATION
        days = 30
        target = this
        variable = { type = name localization = ORIGIN_PLANET scope = event_target:espionage_origin_planet }
        variable = { type = name localization = TARGET_COUNTRY scope = event_target:espionage_target_country }
        variable = { type = name localization = TARGET_PLANET scope = event_target:espionage_target_planet }
        variable = { type = variable localization = VALUE scope = event_target:espionage_origin_country.gained_by_espionage_value }
    }
}